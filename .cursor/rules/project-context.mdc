---
globs: **
description: Project context and core principles
alwaysApply: true
---

# Project Context

## Core Principles
- **Deterministic Simulation**: Fixed-step physics with seeded RNGs
- **Performance Target**: 30+ FPS with 20+ vehicles
- **Quality Standards**: [Quality Standards Guide](mdc:docs/QUALITY_STANDARDS.md)

## Key Components
- **Simulation**: [simulation.py](mdc:src/traffic_sim/core/simulation.py)
- **Drivers**: [driver.py](mdc:src/traffic_sim/core/driver.py)
- **Vehicles**: [vehicle.py](mdc:src/traffic_sim/core/vehicle.py)
- **Rendering**: [app.py](mdc:src/traffic_sim/render/app.py)

## Development Workflow
- **Setup**: `bazel build //...` (Bazel 7.1.1+ build system ready)
- **Testing**: `bazel test //...`
- **Quality**: `bazel build //...` (integrated quality gates)
- **Architecture**: [Architecture Guide](mdc:docs/ARCHITECTURE.md)

## Development Workflow Rules

### Streamlined Hybrid Architecture
The project uses a **streamlined hybrid approach** optimized for efficiency:

#### Bazel Commands (Primary - 95% of workflow)
- **Building**: `bazel build //...` - Build all targets
- **Quality Checks**: `bazel build //...` - Integrated quality gates
- **CI/CD**: All automated processes use Bazel
- **Core Logic**: All simulation logic runs via Bazel

#### Virtual Environment (Development Only - 5% of workflow)
- **Testing**: `uv run python -m pytest tests/` - Run tests with external dependencies
- **Scripts**: `uv run python scripts/benchmarking_framework.py` - Run scripts with dependencies
- **Development**: Only when external dependencies (numpy, arcade, pymunk) are needed

#### Task Commands (Convenience Layer)
- **Quality**: `task quality` - Quality gates via Bazel
- **Performance**: `task performance` - Benchmarking via virtual environment
- **Testing**: `task test` - Testing via virtual environment

### Command Selection Guidelines
- **Use Bazel** for: Building, quality checks, CI/CD, core simulation logic
- **Use Virtual Environment** for: Development, testing, scripts with external dependencies
- **Use Task Commands** for: Convenience and automation

### Efficiency Benefits
- **95% Bazel**: All core functionality uses Bazel
- **5% Virtual Environment**: Only for external dependencies
- **Simplified**: No complex dependency management in Bazel
- **Fast**: Bazel handles most operations efficiently

## Task Commands
- **Quality**: `task quality` (gates), `task quality:monitor` (detailed), `task quality:analyze` (comprehensive)
- **Performance**: `task performance` (benchmark), `task performance:scale` (scalability), `task performance:monitor` (real-time)
- **Specialized**: `task profile` (profiling), `task validate` (validation)

## Project Structure
- **Core Logic**: [src/traffic_sim/core/](mdc:src/traffic_sim/core/) - Simulation engine, vehicles, drivers
- **Rendering**: [src/traffic_sim/render/](mdc:src/traffic_sim/render/) - Arcade-based visualization
- **Configuration**: [config/](mdc:config/) - YAML configuration files (bandit.yaml, quality_gates.yaml, radon.cfg, pyrightconfig.json, benchmarking.yaml)
- **Tests**: [tests/](mdc:tests/) - Comprehensive test suite
- **Documentation**: [docs/](mdc:docs/) - Consolidated guides

## Key Features
- **2D Traffic Simulation**: Stadium track with realistic vehicle behavior
- **Statistical Drivers**: Gaussian copula sampling with correlations
- **IDM Controller**: Intelligent Driver Model with jerk limiting
- **Perception System**: Occlusion-based visibility and dynamic SSD
- **Safety Analytics**: AASHTO/TxDOT-style curve speed calculations
- **Live HUD**: Real-time safety panels and perception data
- **Live Analytics**: Real-time speed histogram, headway distribution, near-miss counter
- **Collision System**: Pymunk physics integration with lateral push effects and vehicle disable
- **Data Logging**: Comprehensive incident tracking, performance metrics, and CSV export
