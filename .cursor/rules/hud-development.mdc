---
globs: src/traffic_sim/core/hud.py,src/traffic_sim/render/app.py
description: HUD development patterns and rendering guidelines
---

# HUD Development Patterns

## Core Functions
- `draw_safety_panel()` - Track safety information
- `draw_perception_summary()` - Perception statistics
- `draw_vehicle_perception_overlay()` - Per-vehicle details
- `draw_perception_heatmap()` - Visual SSD representation

## Rendering Best Practices

### Text Rendering
- **Current**: `arcade.draw_text()` for static text
- **Future**: `arcade.Text` objects for dynamic text (performance optimization)
- **Pattern**: Pre-create text objects in initialization

### Rectangle Drawing
- **Boundary-based**: `arcade.draw_lrtb_rectangle_filled(left, right, top, bottom, color)`
- **Center-based**: `arcade.draw_rectangle_filled(center_x, center_y, width, height, color)`
- **Complex shapes**: `arcade.draw_polygon_filled(point_list, color)`

### Color Coding
- **Green**: Clear perception, safe conditions
- **Red**: Occluded, unsafe conditions
- **Blue**: Information display
- **Gray**: No data available

## Performance Optimization

### Text Objects Pattern
```python
class OptimizedHUD:
    def __init__(self):
        self.text_objects = {}
        self._create_text_objects()
```

### Rendering Order
1. Background elements
2. Static text and panels
3. Dynamic overlays
4. Interactive elements

## Integration

### App.py Integration
- HUD functions called in `on_draw()` method
- Conditional rendering based on `hud_minimal` flag
- Position calculations using screen dimensions

### Data Flow
1. Simulation updates perception data
2. HUD functions access `sim.perception_data`
3. Rendering functions process and display data
4. App coordinates positioning and scaling

## Testing Guidelines

### HUD Testing
- Test data preparation without rendering (no window required)
- Verify calculation accuracy for statistics
- Test with various perception data scenarios
- Ensure no crashes on H key toggle

### Regression Prevention
- Test HUD functions with real simulation data
- Validate color coding and positioning
- Check performance impact on simulation

## Future Enhancements

### Phase 3 HUD Features
- Live speed histogram
- Headway distribution display
- Near-miss counter
- Incident log with timestamps
- Performance metrics overlay

### Optimization Opportunities
- Text object caching
- Batch drawing operations
- Conditional rendering based on visibility
- LOD (Level of Detail) for distant elements