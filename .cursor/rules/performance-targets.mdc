---
globs: src/traffic_sim/core/simulation.py,src/traffic_sim/core/vehicle.py,tests/test_*.py
description: Performance targets and optimization guidelines
---

# Performance Requirements

## Core Targets
- **FPS**: 30+ FPS with 20 vehicles
- **Memory**: Minimal runtime allocations
- **Determinism**: Reproducible behavior with fixed seeds

## Performance Testing Pattern
```python
start_time = time.time()
for i in range(1000):
    sim.step(0.02)
end_time = time.time()
fps_equivalent = 1000 / (end_time * 50)
assert fps_equivalent >= 30, f"Performance below target: {fps_equivalent:.1f} FPS"
```

## Optimization Strategies

### Rendering
- **Text**: Use `Text` objects instead of `draw_text` for frequent updates
- **Rectangles**: Choose appropriate drawing function based on coordinate system
- **Batching**: Group similar drawing operations
- **Caching**: Pre-create commonly used objects

### Simulation
- **Sorting**: Efficient vehicle sorting by position
- **Perception**: Visual range limits prevent excessive computation
- **IDM**: Optimized controller calculations
- **Physics**: Fixed-step simulation for determinism

### Memory
- **Reuse**: Reuse objects where possible
- **Pre-allocation**: Allocate arrays with known sizes
- **Cleanup**: Proper resource cleanup
- **Garbage Collection**: Minimize object creation in loops

## Key Metrics
- Simulation step time (target: < 33ms for 30 FPS)
- Memory usage per vehicle
- Rendering time per frame
- Test execution time

## Warning Signs
- FPS dropping below 30
- Memory usage growing over time
- Test execution time increasing
- Non-deterministic behavior