---
globs: src/traffic_sim/core/simulation.py,src/traffic_sim/core/hud.py
description: Phase 2 perception system implementation patterns
---

# Phase 2: Occlusion-Based Perception + Dynamic SSD

## Core Architecture

### PerceptionData
```python
@dataclass
class PerceptionData:
    leader_vehicle: Optional[Vehicle]
    leader_distance_m: float
    is_occluded: bool
    ssd_required_m: float
    visual_range_m: float
```

### Key Methods
- `_find_first_unobstructed_leader(follower_idx)` - Find visible leader in range
- `_is_line_of_sight_clear(follower, leader, distance)` - Occlusion check
- `_calculate_dynamic_ssd(follower, leader, distance)` - SSD calculation

### SSD Formula
`g_req = max(s0, d_r + v_f²/(2b_f) - v_ℓ²/(2b_ℓ))` where `d_r = v_f * t_r`

## Integration

### Simulation.step()
1. Update perception data for all vehicles
2. Use perception data in IDM controller
3. Fallback to simple following when no leader

### IDM Enhancement
- Use SSD-based desired gap when perception available
- Fallback to standard IDM when occluded/no leader
- Maintain deterministic behavior

### HUD Functions
- `draw_perception_summary()` - Statistics overview
- `draw_vehicle_perception_overlay()` - Per-vehicle details  
- `draw_perception_heatmap()` - Visual SSD representation

## Configuration
```yaml
perception:
  visual_range_m: 200.0
  occlusion_check_resolution: 0.5
  ssd_safety_margin: 1.2
  min_ssd_m: 2.0
```

## Testing
- Occlusion detection accuracy
- SSD calculation validation
- IDM behavior with SSD integration
- Deterministic behavior maintenance
- HUD rendering without crashes

## Performance
- Visual range limits prevent excessive computation
- Line-of-sight checks optimized for stadium geometry
- SSD calculations cached per vehicle per frame
- HUD rendering optimized for 30+ FPS target