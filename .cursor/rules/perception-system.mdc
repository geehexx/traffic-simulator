---
globs: src/traffic_sim/core/simulation.py,src/traffic_sim/core/hud.py
description: Occlusion-based perception and dynamic SSD implementation patterns
---

# Perception System Architecture

## Core Data Structure
```python
@dataclass
class PerceptionData:
    leader_vehicle: Optional[Vehicle]
    leader_distance_m: float
    is_occluded: bool
    ssd_required_m: float
    visual_range_m: float
```

## Key Implementation Methods
- `_find_first_unobstructed_leader(follower_idx)` - Find visible leader in range
- `_is_line_of_sight_clear(follower, leader, distance)` - Occlusion detection
- `_calculate_dynamic_ssd(follower, leader, distance)` - Safe stopping distance

## SSD Calculation
`g_req = max(s0, d_r + v_f²/(2b_f) - v_ℓ²/(2b_ℓ))` where `d_r = v_f * t_r`

## Integration Patterns

### Simulation Integration
1. Update perception data for all vehicles each step
2. Use perception data in IDM controller decisions
3. Fallback to simple following when no leader detected

### IDM Controller Enhancement
- Use SSD-based desired gap when perception available
- Fallback to standard IDM when occluded/no leader
- Maintain deterministic behavior

### HUD Display Functions
- `draw_perception_summary()` - Statistics overview
- `draw_vehicle_perception_overlay()` - Per-vehicle details  
- `draw_perception_heatmap()` - Visual SSD representation

## Configuration Parameters
```yaml
perception:
  visual_range_m: 200.0
  occlusion_check_resolution: 0.5
  ssd_safety_margin: 1.2
  min_ssd_m: 2.0
```

## Testing Requirements
- Occlusion detection accuracy validation
- SSD calculation correctness
- IDM behavior with SSD integration
- Deterministic behavior maintenance
- HUD rendering without crashes

## Performance Considerations
- Visual range limits prevent excessive computation
- Line-of-sight checks optimized for stadium geometry
- SSD calculations cached per vehicle per frame
- HUD rendering optimized for 30+ FPS target